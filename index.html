<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é‡å­ã‚ã‚é…é”å“¡ âš›ï¸ğŸ¬</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=Orbitron:wght@600;900&display=swap" rel="stylesheet">
<style>
:root {
  --cyan:#00f0ff;--pink:#ff2d95;--purple:#a855f7;--green:#39ff14;
  --gold:#ffdd00;--orange:#ff9800;--bg:#0a0a1a;--panel:rgba(10,15,40,0.88);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Zen Maru Gothic',sans-serif;background:var(--bg);color:#e8e8f0;overflow-x:hidden;min-height:100vh}

/* BG */
.bg{position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse at 20% 50%,rgba(0,240,255,.06) 0%,transparent 60%),
  radial-gradient(ellipse at 80% 30%,rgba(255,45,149,.05) 0%,transparent 60%),
  radial-gradient(ellipse at 50% 80%,rgba(168,85,247,.04) 0%,transparent 50%)}
.bg::before{content:'';position:absolute;inset:0;
  background-image:radial-gradient(1px 1px at 10% 20%,rgba(0,240,255,.4),transparent),
  radial-gradient(1px 1px at 30% 70%,rgba(255,45,149,.3),transparent),
  radial-gradient(1.5px 1.5px at 60% 15%,rgba(168,85,247,.5),transparent),
  radial-gradient(1px 1px at 80% 60%,rgba(57,255,20,.3),transparent),
  radial-gradient(1.5px 1.5px at 90% 85%,rgba(255,221,0,.4),transparent);
  animation:twinkle 4s ease-in-out infinite alternate}
@keyframes twinkle{0%{opacity:.4}100%{opacity:1}}

.app{position:relative;z-index:1;max-width:680px;margin:0 auto;padding:12px;text-align:center}

/* Title */
.title{font-family:'Orbitron',monospace;font-size:clamp(1.2em,5vw,1.8em);font-weight:900;
  background:linear-gradient(135deg,var(--cyan),var(--pink),var(--purple));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  filter:drop-shadow(0 0 20px rgba(0,240,255,.4));margin-bottom:2px}
.te{font-size:1.3em;-webkit-text-fill-color:initial}
.sub{font-size:.82em;color:#7888aa;margin-bottom:10px;line-height:1.5}

/* Levels */
.lvl-bar{display:flex;gap:5px;justify-content:center;margin-bottom:10px;flex-wrap:wrap}
.lvl{font-family:'Zen Maru Gothic';font-weight:700;font-size:12px;padding:6px 12px;
  border:2px solid #334;border-radius:20px;background:transparent;color:#99a;cursor:pointer;transition:.25s}
.lvl:hover{border-color:var(--cyan);color:var(--cyan)}
.lvl.on{background:linear-gradient(135deg,var(--cyan),var(--purple));color:#fff;
  border-color:transparent;box-shadow:0 0 14px rgba(0,240,255,.3)}

/* Panel */
.panel{background:var(--panel);border:1px solid rgba(0,240,255,.15);border-radius:12px;
  padding:10px 16px;margin-bottom:10px;backdrop-filter:blur(8px)}
#st{font-size:.92em;min-height:1.3em;margin-bottom:6px;font-weight:700}
.sc{display:flex;justify-content:space-around;font-size:1.1em;font-weight:900}
.sy{color:var(--gold)}.sa{color:var(--cyan)}
.sl{font-weight:400;font-size:.78em;opacity:.7}

/* Canvas */
.cw{position:relative;margin:0 auto;border-radius:14px;overflow:hidden;
  border:2px solid rgba(0,240,255,.2);box-shadow:0 0 30px rgba(0,240,255,.08);max-width:100%}
canvas{display:block;width:100%;height:auto;cursor:crosshair;
  background:radial-gradient(ellipse at center,#101828,#080c18)}

/* Buttons */
.ctrls{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:10px}
.b{font-family:'Zen Maru Gothic';font-weight:700;font-size:14px;padding:10px 18px;border:none;
  border-radius:10px;cursor:pointer;transition:.2s}
.b:active:not(:disabled){transform:scale(.96)}.b:disabled{opacity:.3;cursor:not-allowed}
.bu{background:#1a2444;color:#8899bb}.bu:hover:not(:disabled){background:#253060}
.br{background:linear-gradient(135deg,#2a1a4e,#1a2a4e);color:var(--purple);border:1px solid rgba(168,85,247,.3)}
.bf{background:linear-gradient(135deg,var(--pink),var(--purple));color:#fff;
  box-shadow:0 0 20px rgba(255,45,149,.3);font-size:15px}
.bf:hover:not(:disabled){box-shadow:0 0 30px rgba(255,45,149,.5);filter:brightness(1.1)}

/* Legend */
.leg{margin-top:8px;font-size:11px;display:flex;justify-content:center;gap:14px;flex-wrap:wrap}

/* Ranking */
.rank-sec{margin-top:16px}
.rank-title{font-family:'Orbitron';font-size:14px;color:var(--cyan);margin-bottom:6px}
.rank-table{width:100%;border-collapse:collapse;font-size:13px}
.rank-table th{color:#667;font-weight:400;padding:4px 8px;border-bottom:1px solid #223}
.rank-table td{padding:5px 8px;border-bottom:1px solid #1a1a30}
.rank-table tr.me td{color:var(--gold);font-weight:700}
.rank-input{margin-top:10px}
.rank-input input{background:#0d1525;color:var(--cyan);border:1px solid #334;border-radius:6px;
  padding:6px 10px;font-family:'Zen Maru Gothic';font-size:13px;width:140px;text-align:center}
.rank-input button{margin-left:6px}

/* Overlay */
.ov{display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.75);
  backdrop-filter:blur(6px);justify-content:center;align-items:center}
.ov.show{display:flex}
.ov-card{background:var(--panel);border-radius:20px;padding:28px 36px;text-align:center;
  border:2px solid rgba(0,240,255,.2);animation:pop .4s cubic-bezier(.34,1.56,.64,1)}
@keyframes pop{0%{transform:scale(.5);opacity:0}100%{transform:scale(1);opacity:1}}
.ov-emo{font-size:3.5em;margin-bottom:8px}
.ov-txt{font-size:1.3em;font-weight:900;margin-bottom:4px}
.ov-det{font-size:.85em;color:#8899aa;margin-bottom:14px}
.ov-btn{font-family:'Zen Maru Gothic';font-weight:700;padding:10px 28px;border:none;border-radius:12px;
  background:linear-gradient(135deg,var(--cyan),var(--green));color:#0a0a1a;font-size:15px;cursor:pointer}
.ov-btn:hover{filter:brightness(1.15)}

/* Loading */
.loading #st{animation:qp 1s ease-in-out infinite}
@keyframes qp{0%,100%{color:var(--cyan)}33%{color:var(--pink)}66%{color:var(--purple)}}

/* Celebration particles */
.confetti-container{position:fixed;inset:0;pointer-events:none;z-index:200}
.confetti{position:absolute;width:8px;height:8px;border-radius:50%;animation:fall linear forwards}
@keyframes fall{0%{opacity:1;transform:translateY(0) rotate(0deg)}100%{opacity:0;transform:translateY(100vh) rotate(720deg)}}

.app{touch-action:none;-webkit-user-select:none;user-select:none}
</style>
</head>
<body>
<div class="bg"></div>
<div class="app">
  <div class="title"><span class="te">âš›ï¸</span> QUANTUM CANDY <span class="te">ğŸ¬</span></div>
  <p class="sub">å…¨éƒ¨ã®å®¶ã«ã‚ã‚ã‚’é…ã£ã¦ã€æœ€çŸ­ãƒ«ãƒ¼ãƒˆã§å¸°ã£ã¦ã“ã‚ˆã†ğŸ <br>é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿AIã«å‹ã¦ã‚‹ã‹ãªï¼Ÿ</p>

  <div class="lvl-bar" id="lvlBar"></div>

  <div class="panel" id="mainPanel">
    <div id="st">ãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼</div>
    <div class="sc">
      <div><span class="sl">ã‚ãªãŸ ğŸ§’</span><br><span class="sy" id="ps">---</span></div>
      <div><span class="sl">é‡å­AI ğŸ¤–</span><br><span class="sa" id="as">---</span></div>
    </div>
  </div>

  <div class="cw"><canvas id="c" width="600" height="600"></canvas></div>

  <div class="ctrls">
    <button class="b bu" id="ubtn" onclick="undo()" disabled>â†© ã‚‚ã©ã™</button>
    <button class="b br" onclick="resetLv()">ğŸ”„ ã‚„ã‚ŠãªãŠã—</button>
    <button class="b bf" id="fbtn" onclick="fight()" disabled>âš¡ é‡å­AIã¨å¯¾æ±ºï¼</button>
  </div>

  <div class="leg">
    <span style="color:var(--gold)">â”â” ã‚ãªãŸ</span>
    <span style="color:var(--orange)">â”…â”… å¸°ã‚ŠğŸ </span>
    <span style="color:var(--cyan)">â”…â”… é‡å­AI</span>
  </div>

  <!-- Ranking -->
  <div class="rank-sec">
    <div class="rank-title">ğŸ† ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
    <div class="rank-input">
      <input id="nameIn" placeholder="ãªã¾ãˆ" maxlength="12">
      <button class="b bu" onclick="saveName()" style="padding:6px 12px;font-size:12px">ç™»éŒ²</button>
    </div>
    <table class="rank-table" id="rankTable">
      <thead><tr><th>#</th><th>ãªã¾ãˆ</th><th>Lv</th><th>è·é›¢</th><th>æ—¥æ™‚</th></tr></thead>
      <tbody id="rankBody"></tbody>
    </table>
  </div>
</div>

<!-- Result overlay -->
<div class="ov" id="ov">
  <div class="ov-card">
    <div class="ov-emo" id="oE"></div>
    <div class="ov-txt" id="oT"></div>
    <div class="ov-det" id="oD"></div>
    <button class="ov-btn" id="oB" onclick="nextAct()">ã¤ãã¸</button>
  </div>
</div>
<div class="confetti-container" id="confetti"></div>

<script>
// ==================== LEVELS ====================
const LEVELS = [
  { name:"ğŸŒ± ã‹ã‚“ãŸã‚“", houses:4, shots:50, T_num:1000 },
  { name:"ğŸŒ¿ ãµã¤ã†",   houses:5, shots:80, T_num:2000 },
  { name:"ğŸ”¥ ã‚€ãšã‹ã—ã„",houses:6, shots:100,T_num:3000 },
  { name:"ğŸ’€ ã‚²ã‚­ãƒ ã‚º", houses:7, shots:120,T_num:5000 },
  { name:"âš›ï¸ é‡å­ãƒã‚¹ã‚¿ãƒ¼",houses:8,shots:150,T_num:6000 },
];
let curLv=1, houses=[], pPath=[], aiPathD=null, ended=false, playerName='';

const cv=document.getElementById('c'), cx=cv.getContext('2d');
const stE=document.getElementById('st'), psE=document.getElementById('ps'), asE=document.getElementById('as');
const fbtn=document.getElementById('fbtn'), ubtn=document.getElementById('ubtn');

// Build level buttons
const lb=document.getElementById('lvlBar');
LEVELS.forEach((l,i)=>{const b=document.createElement('button');b.className='lvl'+(i===curLv?' on':'');
  b.textContent=l.name;b.onclick=()=>selLv(i);lb.appendChild(b)});

function selLv(i){curLv=i;document.querySelectorAll('.lvl').forEach((b,j)=>b.classList.toggle('on',j===i));initGame()}
function resetLv(){initGame()}

// ==================== GAME ====================
function initGame(){
  const lv=LEVELS[curLv];houses=[];pPath=[];aiPathD=null;ended=false;
  fbtn.disabled=true;ubtn.disabled=true;
  stE.textContent=`Lv.${curLv+1} ${lv.houses}è»’ã®è¡— â€” å®¶ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã­ï¼`;
  document.getElementById('mainPanel').classList.remove('loading');
  psE.textContent='---';asE.textContent='---';
  const N=lv.houses,minD=Math.max(60,360/N);
  for(let i=0;i<N;i++){let a=0,h;
    do{h={x:45+Math.random()*(cv.width-90),y:45+Math.random()*(cv.height-90),id:i};a++}
    while(houses.some(o=>Math.hypot(o.x-h.x,o.y-h.y)<minD)&&a<300);houses.push(h)}
  animFrame=null;draw()
}

// ==================== DRAW ====================
let animFrame=null, routeAnimProg=0;

function draw(){
  cx.clearRect(0,0,cv.width,cv.height);
  // Grid
  cx.strokeStyle='rgba(0,240,255,.04)';cx.lineWidth=.5;
  for(let x=0;x<cv.width;x+=40){cx.beginPath();cx.moveTo(x,0);cx.lineTo(x,cv.height);cx.stroke()}
  for(let y=0;y<cv.height;y+=40){cx.beginPath();cx.moveTo(0,y);cx.lineTo(cv.width,y);cx.stroke()}
  const N=houses.length;

  // Player path (solid gold)
  if(pPath.length>1){
    cx.strokeStyle='rgba(255,221,0,.8)';cx.lineWidth=3;cx.setLineDash([]);
    cx.shadowColor='#ffdd00';cx.shadowBlur=8;cx.beginPath();
    cx.moveTo(houses[pPath[0]].x,houses[pPath[0]].y);
    for(let i=1;i<pPath.length;i++) cx.lineTo(houses[pPath[i]].x,houses[pPath[i]].y);
    cx.stroke();cx.shadowBlur=0;
    // Return leg (dashed orange)
    if(pPath.length===N){
      const L=houses[pPath[N-1]],F=houses[pPath[0]];
      cx.strokeStyle='#ff9800';cx.lineWidth=2.5;cx.setLineDash([8,6]);
      cx.beginPath();cx.moveTo(L.x,L.y);cx.lineTo(F.x,F.y);cx.stroke();cx.setLineDash([]);
      // Arrow
      const ang=Math.atan2(F.y-L.y,F.x-L.x),mx=(L.x+F.x)/2,my=(L.y+F.y)/2;
      cx.fillStyle='#ff9800';cx.beginPath();
      cx.moveTo(mx+10*Math.cos(ang),my+10*Math.sin(ang));
      cx.lineTo(mx-6*Math.cos(ang-.5),my-6*Math.sin(ang-.5));
      cx.lineTo(mx-6*Math.cos(ang+.5),my-6*Math.sin(ang+.5));
      cx.closePath();cx.fill();
      cx.font='12px sans-serif';cx.textAlign='center';cx.fillText('ğŸ å¸°ã‚Š',mx,my-12);
    }
  }

  // AI path (animated)
  if(aiPathD){
    const pts=[];for(let i=0;i<aiPathD.length;i++)pts.push(houses[aiPathD[i]]);
    pts.push(houses[aiPathD[0]]); // close loop
    const total=pts.length-1;
    const drawN=Math.min(total, Math.floor(routeAnimProg*total)+1);
    const frac=routeAnimProg*total-Math.floor(routeAnimProg*total);

    // Glow trail
    cx.strokeStyle='rgba(0,240,255,.15)';cx.lineWidth=8;cx.setLineDash([]);
    cx.beginPath();cx.moveTo(pts[0].x,pts[0].y);
    for(let i=1;i<=drawN&&i<pts.length;i++){
      if(i===drawN&&i<pts.length){
        const px=pts[i-1],nx=pts[i];
        cx.lineTo(px.x+(nx.x-px.x)*frac,px.y+(nx.y-px.y)*frac);
      }else cx.lineTo(pts[i].x,pts[i].y);
    }
    cx.stroke();

    // Main line
    cx.strokeStyle='rgba(0,240,255,.8)';cx.lineWidth=2.5;cx.setLineDash([8,5]);
    cx.shadowColor='#00f0ff';cx.shadowBlur=10;cx.beginPath();cx.moveTo(pts[0].x,pts[0].y);
    for(let i=1;i<=drawN&&i<pts.length;i++){
      if(i===drawN&&i<pts.length){
        const px=pts[i-1],nx=pts[i];
        cx.lineTo(px.x+(nx.x-px.x)*frac,px.y+(nx.y-px.y)*frac);
      }else cx.lineTo(pts[i].x,pts[i].y);
    }
    cx.stroke();cx.setLineDash([]);cx.shadowBlur=0;

    // Animated particle along AI path
    if(routeAnimProg<1){
      const segIdx=Math.min(Math.floor(routeAnimProg*total),total-1);
      const segFrac=routeAnimProg*total-segIdx;
      const p1=pts[segIdx],p2=pts[segIdx+1]||pts[segIdx];
      const px=p1.x+(p2.x-p1.x)*segFrac, py=p1.y+(p2.y-p1.y)*segFrac;
      cx.fillStyle='#00f0ff';cx.shadowColor='#00f0ff';cx.shadowBlur=20;
      cx.beginPath();cx.arc(px,py,5,0,Math.PI*2);cx.fill();cx.shadowBlur=0;
    }
  }

  // Houses
  const cols=['#ff2d95','#00f0ff','#a855f7','#39ff14','#ffdd00','#ff6b35','#00d4aa','#f472b6'];
  houses.forEach((h,idx)=>{
    const vi=pPath.indexOf(idx);
    if(vi<0&&!ended&&pPath.length>0){cx.beginPath();cx.arc(h.x,h.y,24,0,Math.PI*2);
      cx.strokeStyle='rgba(0,240,255,.2)';cx.lineWidth=1.5;cx.stroke()}
    const col=cols[idx%cols.length];
    cx.shadowColor=col;cx.shadowBlur=vi>=0?5:15;
    cx.fillStyle=col;cx.globalAlpha=vi>=0?.6:1;
    cx.beginPath();cx.arc(h.x,h.y,16,0,Math.PI*2);cx.fill();
    cx.globalAlpha=1;cx.shadowBlur=0;
    cx.fillStyle=vi>=0?'rgba(255,255,255,.9)':'#fff';
    cx.beginPath();cx.arc(h.x,h.y,10,0,Math.PI*2);cx.fill();
    cx.fillStyle='#0a0a1a';cx.font='bold 12px "Orbitron"';cx.textAlign='center';cx.textBaseline='middle';
    cx.fillText(idx+1,h.x,h.y+1);
    if(vi>=0){cx.fillStyle='rgba(255,221,0,.9)';cx.font='700 10px "Zen Maru Gothic"';
      cx.fillText(`${vi+1}ç•ª`,h.x,h.y+26)}
  });

  // Start house highlight
  if(pPath.length>0){
    const s=houses[pPath[0]];
    cx.strokeStyle='rgba(255,153,0,.6)';cx.lineWidth=2;cx.setLineDash([4,3]);
    cx.beginPath();cx.arc(s.x,s.y,20,0,Math.PI*2);cx.stroke();cx.setLineDash([]);
    cx.fillStyle='rgba(255,153,0,.8)';cx.font='9px sans-serif';cx.fillText('START',s.x,s.y-22);
  }
}

// ==================== DISTANCE ====================
function tourDist(path){
  let d=0;
  for(let i=0;i<path.length-1;i++) d+=Math.hypot(houses[path[i]].x-houses[path[i+1]].x,houses[path[i]].y-houses[path[i+1]].y);
  d+=Math.hypot(houses[path[path.length-1]].x-houses[path[0]].x,houses[path[path.length-1]].y-houses[path[0]].y);
  return Math.floor(d);
}

// ==================== INPUT ====================
cv.addEventListener('click',e=>{if(!ended)selAt(pos(e))});
cv.addEventListener('touchend',e=>{if(ended)return;e.preventDefault();
  const t=e.changedTouches[0],r=cv.getBoundingClientRect();
  selAt({x:(t.clientX-r.left)*(cv.width/r.width),y:(t.clientY-r.top)*(cv.height/r.height)})},{passive:false});
cv.addEventListener('touchstart',e=>e.preventDefault(),{passive:false});
cv.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});
function pos(e){const r=cv.getBoundingClientRect();return{x:(e.clientX-r.left)*(cv.width/r.width),y:(e.clientY-r.top)*(cv.height/r.height)}}

function selAt(p){
  let bi=-1,bd=35;
  houses.forEach((h,i)=>{if(pPath.includes(i))return;const d=Math.hypot(h.x-p.x,h.y-p.y);if(d<bd){bd=d;bi=i}});
  if(bi>=0){
    pPath.push(bi);ubtn.disabled=false;draw();
    const rem=houses.length-pPath.length;
    if(rem>1)stE.textContent=`ã‚ã¨${rem}è»’ï¼`;
    else if(rem===1)stE.textContent='ã‚ã¨1è»’ï¼ æœ€å¾Œã«é¸ã‚“ã ã‚‰ğŸ ã«å¸°ã‚‹ã‚ˆ';
    else finishP();
  }
}
function undo(){if(!pPath.length||ended)return;pPath.pop();ubtn.disabled=!pPath.length;fbtn.disabled=true;
  psE.textContent='---';stE.textContent=pPath.length?`ã‚ã¨${houses.length-pPath.length}è»’ï¼`:'å®¶ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã­ï¼';draw()}
function finishP(){
  const d=tourDist(pPath);psE.textContent=d;
  stE.textContent=`ğŸ  å¸°é‚„å®Œäº†ï¼ ç·è·é›¢: ${d} â€” é‡å­AIã¨å‹è² ã—ã‚ˆã†ï¼`;fbtn.disabled=false;ubtn.disabled=true}

// ==================== FIGHT ====================
async function fight(){
  if(ended)return;ended=true;fbtn.disabled=true;ubtn.disabled=true;
  stE.textContent='âš›ï¸ é‡å­ã‚¢ãƒ‹ãƒ¼ãƒªãƒ³ã‚°ä¸­...';document.getElementById('mainPanel').classList.add('loading');
  const lv=LEVELS[curLv];
  try{
    const res=await fetch('/api/solve_tsp',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({houses,shots:lv.shots,T_num:lv.T_num})});
    if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e.error||`Error ${res.status}`)}
    const data=await res.json();
    if(!data.path||!Array.isArray(data.path))throw new Error('ä¸æ­£ãªå¿œç­”');
    aiPathD=data.path;
    const aiDist=tourDist(data.path);asE.textContent=aiDist;
    document.getElementById('mainPanel').classList.remove('loading');
    // Animate AI route
    routeAnimProg=0;
    const animStart=Date.now(),animDur=1500;
    function animLoop(){
      routeAnimProg=Math.min(1,(Date.now()-animStart)/animDur);
      draw();
      if(routeAnimProg<1)requestAnimationFrame(animLoop);
      else{const pD=parseInt(psE.textContent);showResult(pD,aiDist)}
    }
    animLoop();
  }catch(e){console.error(e);document.getElementById('mainPanel').classList.remove('loading');
    stE.textContent=`âš ï¸ ${e.message}`;ended=false;fbtn.disabled=false}
}

// ==================== RESULT ====================
function showResult(pD,aiD){
  const oE=document.getElementById('oE'),oT=document.getElementById('oT'),
    oD=document.getElementById('oD'),oB=document.getElementById('oB');
  if(pD<aiD){oE.textContent='ğŸ‰ğŸ†ğŸ¬';oT.textContent='ãã¿ã®å‹ã¡ï¼';oT.style.color='#39ff14';
    oD.textContent=`ãã¿ ${pD} vs é‡å­AI ${aiD}`;stE.textContent='ğŸ‰ å‹åˆ©ï¼';spawnConfetti()}
  else if(pD===aiD){oE.textContent='ğŸ¤âš¡';oT.textContent='å¼•ãåˆ†ã‘ï¼';oT.style.color='#ffdd00';
    oD.textContent=`ã©ã¡ã‚‰ã‚‚ ${pD}`;stE.textContent='ğŸ¤ å¼•ãåˆ†ã‘ï¼'}
  else{oE.textContent='ğŸ¤–âš›ï¸ğŸ’ª';oT.textContent='é‡å­AIã®å‹ã¡ï¼';oT.style.color='#00f0ff';
    oD.textContent=`é‡å­AI ${aiD} vs ãã¿ ${pD}`;stE.textContent='ğŸ¤– é‡å­AIã®å‹åˆ©ï¼'}
  oB.textContent=pD<=aiD&&curLv<LEVELS.length-1?'ğŸš€ æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸ï¼':'ğŸ”„ ã‚‚ã†ä¸€å›ï¼';
  document.getElementById('ov').classList.add('show');
  // Save to ranking
  saveScore(pD,aiD);
}
function nextAct(){document.getElementById('ov').classList.remove('show');
  const pD=parseInt(psE.textContent),aiD=parseInt(asE.textContent);
  if(pD<=aiD&&curLv<LEVELS.length-1)selLv(curLv+1);else initGame()}

// ==================== CONFETTI ====================
function spawnConfetti(){
  const c=document.getElementById('confetti');c.innerHTML='';
  const colors=['#ff2d95','#00f0ff','#a855f7','#39ff14','#ffdd00','#ff9800'];
  for(let i=0;i<60;i++){const p=document.createElement('div');p.className='confetti';
    p.style.left=Math.random()*100+'%';p.style.top=-10+'px';
    p.style.background=colors[Math.floor(Math.random()*colors.length)];
    p.style.width=p.style.height=(4+Math.random()*8)+'px';
    p.style.animationDuration=(1.5+Math.random()*2)+'s';
    p.style.animationDelay=(Math.random()*.5)+'s';
    c.appendChild(p)}
  setTimeout(()=>c.innerHTML='',4000);
}

// ==================== RANKING (localStorage) ====================
let rankings=[];
function loadRankings(){try{rankings=JSON.parse(localStorage.getItem('qc_rank')||'[]')}catch{rankings=[]}}
function saveRankings(){try{localStorage.setItem('qc_rank',JSON.stringify(rankings.slice(0,50)))}catch{}}
function loadName(){playerName=localStorage.getItem('qc_name')||'';document.getElementById('nameIn').value=playerName}
function saveName(){playerName=document.getElementById('nameIn').value.trim()||'ã‚²ã‚¹ãƒˆ';
  localStorage.setItem('qc_name',playerName);renderRank()}
function saveScore(pD,aiD){
  if(!playerName)playerName=document.getElementById('nameIn').value.trim()||'ã‚²ã‚¹ãƒˆ';
  const won=pD<=aiD;
  rankings.push({name:playerName,lv:curLv+1,dist:pD,aiDist:aiD,won,ts:Date.now()});
  rankings.sort((a,b)=>{if(a.lv!==b.lv)return b.lv-a.lv;return a.dist-b.dist});
  saveRankings();renderRank()}

function renderRank(){
  const tb=document.getElementById('rankBody');tb.innerHTML='';
  const top=rankings.slice(0,10);
  top.forEach((r,i)=>{
    const tr=document.createElement('tr');
    if(r.ts===rankings.find(x=>x.name===playerName&&x.lv===r.lv&&x.dist===r.dist)?.ts)tr.className='me';
    const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':(i+1);
    const dt=new Date(r.ts);const ds=`${dt.getMonth()+1}/${dt.getDate()} ${dt.getHours()}:${String(dt.getMinutes()).padStart(2,'0')}`;
    tr.innerHTML=`<td>${medal}</td><td>${esc(r.name)}</td><td>Lv.${r.lv}</td><td>${r.dist}${r.won?'âœ¨':''}</td><td>${ds}</td>`;
    tb.appendChild(tr)});
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// ==================== INIT ====================
loadRankings();loadName();selLv(1);renderRank();
</script>
</body>
</html>
